<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D WebGL Racing Simulation</title>
    <style>
        body{margin:0;overflow:hidden;font-family:Arial,Helvetica,sans-serif}
        #info{position:absolute;top:10px;width:100%;text-align:center;color:#fff;font-weight:bold;text-shadow:1px 1px 1px #000;pointer-events:none;z-index:100}
        #controls{position:absolute;bottom:10px;left:10px;padding:10px;background:rgba(0,0,0,.5);color:#fff;border-radius:5px;pointer-events:none;z-index:100}
        #car-indicator{position:absolute;top:80px;width:100%;text-align:center;color:#fff;font-weight:bold;text-shadow:1px 1px 1px #000;pointer-events:none;z-index:100}
        #ui-panel{position:absolute;top:10px;right:10px;width:240px;background:rgba(0,0,0,.7);color:#fff;padding:15px;border-radius:5px;z-index:100}
        #hud{position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.5);color:#fff;padding:10px;border-radius:5px;z-index:100}
        #camera-mode{position:absolute;top:50px;width:100%;text-align:center;color:#fff;font-weight:bold;text-shadow:1px 1px 1px #000;pointer-events:none;z-index:100}
        .slider-container{margin:8px 0}
        .slider-container label{display:block;margin-bottom:4px}
        input[type=range]{width:100%}
        button{background:#4caf50;color:#fff;border:none;padding:8px 12px;margin:4px 0;border-radius:4px;cursor:pointer;width:100%}
        button:hover{background:#45a049}
        .active{background:#e74c3c!important}
    </style>
</head>
<body>
<div id="info">3D WebGL Racing Simulation</div>
<div id="camera-mode">Kamera Modu: <span id="mode-indicator">Araç Sabit</span></div>
<div id="car-indicator">Aktif Araç: <span id="active-car">Mavi Araç</span></div>
<div id="controls">Araç: <strong>W‑A‑S‑D</strong> • Kamera: <strong>Fare</strong> • <kbd>R</kbd>: Reset • <kbd>C</kbd>: Kamera Modu Değiştir • <kbd>V</kbd>: Araç Değiştir</div>
<div id="ui-panel">
  <h3>Aydınlatma & Yağmur</h3>
  <div class="slider-container"><label>Işık X: <span id="light-x-val">50</span></label><input type="range" id="light-x" min="-100" max="100" value="50"></div>
  <div class="slider-container"><label>Işık Y: <span id="light-y-val">100</span></label><input type="range" id="light-y" min="0" max="200" value="100"></div>
  <div class="slider-container"><label>Işık Z: <span id="light-z-val">50</span></label><input type="range" id="light-z" min="-100" max="100" value="50"></div>
  <div class="slider-container"><label>Parlaklık: <span id="light-intensity-val">1</span></label><input type="range" id="light-intensity" min="0" max="2" step="0.1" value="1"></div>
  <hr>
  <div class="slider-container"><label>Yağmur: <span id="rain-intensity-val">0.5</span></label><input type="range" id="rain-intensity" min="0" max="1" step="0.1" value="0.5"></div>
</div>
<div id="hud">Hız: <span id="speed">0</span> km/sa</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script>
/********************
 * GLOBAL VARIABLES *
 *******************/
let scene, camera, renderer, clock, controlsOrbit;
let sunLight, ambLight, headLight, rainSystem;
let car, wingoCar; // iki araç
let activeCarIndex = 0; // 0: mavi araç, 1: wingo araç
const cars = [null, null]; // [mainCar, wingoCar]
const keys = {};
const carParams = {speed: 0, maxSpeed: 140, accel: 70, brake: 100, turnSpeed: Math.PI};

// Camera modes
let cameraMode = 'car'; // 'car' or 'free'
let lastCarPosition = new THREE.Vector3();
let lastCarRotation = new THREE.Quaternion();

/********************
 * INITIALISATION   *
 *******************/
init();
function init(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);
  
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0, 8, 15);

  renderer = new THREE.WebGLRenderer({antialias: true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  document.body.appendChild(renderer.domElement);
  clock = new THREE.Clock();

  controlsOrbit = new THREE.OrbitControls(camera, renderer.domElement);
  controlsOrbit.enablePan = false;
  controlsOrbit.enableKeys = false;
  controlsOrbit.maxPolarAngle = Math.PI/2.2;
  controlsOrbit.enabled = false; // Başlangıçta kapalı, car mode aktif

  addLights();
  createTerrain();
  createRain();
  
  // İlk önce araçları yükle
  loadMainCar();   // mevcut mavi araç
  loadWingoCar();  // yeni wingo aracı
  
  setupUI();

  window.addEventListener('resize', onResize);
  window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if(e.code === 'KeyR') resetCar();
    if(e.code === 'KeyC') toggleCameraMode();
    if(e.code === 'KeyV') switchCar();
  });
  window.addEventListener('keyup', e => keys[e.code] = false);
  animate();
}

// Toggle camera mode between car-fixed and free orbit
function toggleCameraMode() {
  const activeCar = cars[activeCarIndex];
  if(!activeCar) return;
  
  if(cameraMode === 'car') {
    cameraMode = 'free';
    controlsOrbit.enabled = true;
    // Current position becomes the orbit center
    controlsOrbit.target.copy(activeCar.position);
    document.getElementById('mode-indicator').textContent = 'Serbest';
  } else {
    cameraMode = 'car';
    controlsOrbit.enabled = false;
    // Kamerayı hemen aracın arkasına getir
    const camOff = new THREE.Vector3(0, 5, 12).applyQuaternion(activeCar.quaternion);
    camera.position.copy(activeCar.position).add(camOff);
    camera.lookAt(activeCar.position);
    document.getElementById('mode-indicator').textContent = 'Araç Sabit';
  }
}

/******************** LIGHTS *******************/
function addLights(){
  ambLight = new THREE.AmbientLight(0xffffff, 0.4);
  scene.add(ambLight);
  
  sunLight = new THREE.DirectionalLight(0xffffff, 1);
  sunLight.position.set(50, 120, 50);
  sunLight.castShadow = true;
  scene.add(sunLight);
  
  headLight = new THREE.SpotLight(0xffffff, 1, 120, Math.PI/8, 0.5, 0.9);
  headLight.castShadow = true;
  scene.add(headLight);
}

/******************** TERRAIN *******************/
function createTerrain(){
  const plane = new THREE.Mesh(
    new THREE.PlaneGeometry(500, 500),
    new THREE.MeshStandardMaterial({color: 0x267f00})
  );
  plane.rotation.x = -Math.PI/2;
  plane.receiveShadow = true;
  scene.add(plane);
}

/******************** RAIN *******************/
function createRain(){
  const cnt = 3000;
  const arr = new Float32Array(cnt * 3);
  for(let i = 0; i < cnt; i++){
    arr[i*3] = Math.random() * 400 - 200;
    arr[i*3+1] = Math.random() * 200;
    arr[i*3+2] = Math.random() * 400 - 200;
  }
  const geo = new THREE.BufferGeometry();
  geo.setAttribute('position', new THREE.BufferAttribute(arr, 3));
  const mat = new THREE.PointsMaterial({color: 0xccccff, size: 0.6, transparent: true, opacity: 0.3});
  rainSystem = new THREE.Points(geo, mat);
  rainSystem.visible = true;
  scene.add(rainSystem);
}

function updateRain(dt){
  if(!rainSystem.visible) return;
  const pos = rainSystem.geometry.attributes.position.array;
  for(let i = 0; i < pos.length; i += 3){
    pos[i+1] -= dt * 80;
    if(pos[i+1] < 0) pos[i+1] = 200;
  }
  rainSystem.geometry.attributes.position.needsUpdate = true;
}

/******************** MAIN CAR *******************/
function loadMainCar(){
  const loader = new THREE.GLTFLoader();
  loader.load('assets/lowpolycarblue.glb', 
    g => {
      car = g.scene;
      car.traverse(c => { c.castShadow = c.receiveShadow = true; });
      fitOnGround(car);
      car.rotation.y = Math.PI/2; // Başlangıçta 90 derece dönük
      scene.add(car);
      // Add to cars array
      cars[0] = car;
      // Initialize last positions
      lastCarPosition.copy(car.position);
      lastCarRotation.copy(car.quaternion);
    },
    undefined,
    err => {
      console.warn('lowpolycarblue.glb yüklenemedi', err);
      car = new THREE.Mesh(
        new THREE.BoxGeometry(3, 1, 2),
        new THREE.MeshStandardMaterial({color: 0xff4444})
      );
      fitOnGround(car);
      car.rotation.y = Math.PI/2; // Başlangıçta 90 derece dönük
      scene.add(car);
      // Add to cars array
      cars[0] = car;
      // Initialize last positions for fallback car
      lastCarPosition.copy(car.position);
      lastCarRotation.copy(car.quaternion);
    }
  );
}

/******************** WINGO CAR *******************/
function loadWingoCar(){
  const loader = new THREE.GLTFLoader();
  loader.setPath('assets/wingo/source/');
  loader.setResourcePath('../textures/');
  loader.load('wingo.glb',
    g => {
      wingoCar = g.scene;
      wingoCar.traverse(o => o.castShadow = o.receiveShadow = true);
      fitOnGround(wingoCar);
      wingoCar.position.set(10, wingoCar.position.y, 0); // Ana aracın yanında
      wingoCar.rotation.y = Math.PI/2; // Başlangıçta 90 derece dönük
      scene.add(wingoCar);
      // Add to cars array
      cars[1] = wingoCar;
    },
    undefined,
    err => console.error('wingo.glb yüklenemedi:', err)
  );
}

/******************** UTILS *******************/
function fitOnGround(obj){
  obj.updateWorldMatrix(true, true);
  const b = new THREE.Box3().setFromObject(obj);
  const h = (b.max.y - b.min.y) || 1;
  obj.position.set(obj.position.x, h/2 + 0.05, obj.position.z);
  obj.scale.set(2, 2, 2);
  if(!obj.rotation.y) obj.rotation.y = Math.PI;
}

function resetCar(){
  const activeCar = cars[activeCarIndex];
  if(!activeCar) return;
  
  // Araçları farklı başlangıç pozisyonlarına koy
  if(activeCarIndex === 0) {
    activeCar.position.set(0, activeCar.position.y, 0);
  } else {
    activeCar.position.set(10, activeCar.position.y, 0);
  }
  activeCar.rotation.set(0, Math.PI/2, 0); // 90 derece dönük
  carParams.speed = 0;
  
  // If in free camera mode, update the orbit target
  if(cameraMode === 'free') {
    controlsOrbit.target.copy(activeCar.position);
  }
}

// Switch between cars
function switchCar() {
  // Geçerli aracın son pozisyonunu ve rotasyonunu kaydet
  const prevCar = cars[activeCarIndex];
  if(prevCar) {
    lastCarPosition.copy(prevCar.position);
    lastCarRotation.copy(prevCar.quaternion);
  }
  
  // Araç değiştir
  activeCarIndex = (activeCarIndex + 1) % 2;
  document.getElementById('active-car').textContent = activeCarIndex === 0 ? 'Mavi Araç' : 'Wingo Araç';
  
  // Kamerayı yeni araç konumuna göre ayarla
  const activeCar = cars[activeCarIndex];
  if(activeCar) {
    if(cameraMode === 'car') {
      // Araç modunda kamerayı ayarla
      const camOff = new THREE.Vector3(0, 5, 12).applyQuaternion(activeCar.quaternion);
      camera.position.copy(activeCar.position).add(camOff);
      camera.lookAt(activeCar.position);
    } else {
      // Free modda orbit hedefini güncelle
      controlsOrbit.target.copy(activeCar.position);
    }
  }
}

/******************** DRIVE CAR *******************/
function driveCar(dt){
  const activeCar = cars[activeCarIndex];
  if(!activeCar) return;
  
  if(keys['KeyW']) carParams.speed += carParams.accel * dt;
  if(keys['KeyS']) carParams.speed -= carParams.brake * dt;
  carParams.speed = THREE.MathUtils.clamp(carParams.speed, -40, carParams.maxSpeed);
  carParams.speed *= 0.98;
  
  if(keys['KeyA']) activeCar.rotation.y += carParams.turnSpeed * dt;
  if(keys['KeyD']) activeCar.rotation.y -= carParams.turnSpeed * dt;
  
  // Araç tekerlek yönünde hareket etsin
  const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(activeCar.quaternion);
  activeCar.position.add(dir.multiplyScalar(carParams.speed * dt));
  
  document.getElementById('speed').textContent = Math.abs(carParams.speed).toFixed(0);
  
  // Update camera based on mode
  updateCamera();
  
  // Store current position and rotation for next frame
  lastCarPosition.copy(activeCar.position);
  lastCarRotation.copy(activeCar.quaternion);
}

/******************** CAMERA CONTROL *******************/
function updateCamera() {
  const activeCar = cars[activeCarIndex];
  if(!activeCar) return;
  
  if(cameraMode === 'car') {
    // Fixed to car mode - daha düzgün kamera takibi
    const camOff = new THREE.Vector3(0, 5, 12).applyQuaternion(activeCar.quaternion);
    const targetCamPos = activeCar.position.clone().add(camOff);
    camera.position.lerp(targetCamPos, 0.1);
    camera.lookAt(activeCar.position);
  } else {
    // Free orbit mode - the orbit controls handle the camera movement
    // Just update the target position to follow the car if it's moving fast
    if(carParams.speed > 10 || carParams.speed < -10) {
      controlsOrbit.target.lerp(activeCar.position, 0.05);
    }
    controlsOrbit.update();
  }
}

function updateHeadLight(){
  const activeCar = cars[activeCarIndex];
  if(!activeCar) return;
  
  const dir = new THREE.Vector3(0, -0.2, -1).applyQuaternion(activeCar.quaternion);
  headLight.position.copy(activeCar.position).add(new THREE.Vector3(0, 2, 0));
  headLight.target.position.copy(activeCar.position.clone().add(dir.multiplyScalar(20)));
  headLight.target.updateMatrixWorld();
}

/******************** UI *******************/
function setupUI(){
  ['light-x', 'light-y', 'light-z', 'light-intensity'].forEach(id => 
    document.getElementById(id).addEventListener('input', onLightChange)
  );
  
  document.getElementById('rain-intensity').addEventListener('input', e => {
    const v = parseFloat(e.target.value);
    document.getElementById('rain-intensity-val').textContent = v.toFixed(1);
    rainSystem.visible = v > 0;
    rainSystem.material.opacity = 0.5 * v;
  });
  
  onLightChange();
}

function onLightChange(){
  const lx = document.getElementById('light-x');
  const ly = document.getElementById('light-y');
  const lz = document.getElementById('light-z');
  const li = document.getElementById('light-intensity');
  
  // Işık konum & parlaklık
  sunLight.position.set(
    parseFloat(lx.value),
    parseFloat(ly.value),
    parseFloat(lz.value)
  );
  sunLight.intensity = parseFloat(li.value);
  
  // Ekrandaki sayıları güncelle
  document.getElementById('light-x-val').textContent = lx.value;
  document.getElementById('light-y-val').textContent = ly.value;
  document.getElementById('light-z-val').textContent = lz.value;
  document.getElementById('light-intensity-val').textContent = li.value;
}

/******************** LOOP *******************/
function animate(){
  requestAnimationFrame(animate);
  const dt = clock.getDelta();
  driveCar(dt);
  updateRain(dt);
  updateHeadLight();
  renderer.render(scene, camera);
}

function onResize(){
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}
</script>
</body>
</html>